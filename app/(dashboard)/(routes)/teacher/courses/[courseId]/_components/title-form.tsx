"use client";

import * as z from "zod";
import toast from "react-hot-toast";
import axios from "axios";
import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import { useState } from "react";
import { useRouter } from "next/navigation";
import { Tooltip } from "react-tooltip";

import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormMessage,
} from "@/components/ui/form";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Pencil } from "lucide-react";

// create the form schema
const formSchema = z.object({
  title: z.string().min(1, {
    // make sure the title is at least 1 character long
    message: "Title is required",
  }),
});

// create the form types
interface TitleFormProps {
  initialData: {
    title: string;
  };
  courseId: string;
}

const TitleForm = ({ initialData, courseId }: TitleFormProps) => {
  const [isEditing, setIsEditing] = useState(false);
  const router = useRouter();

  // toggle function to switch between editing and not editing
  const toggleEditing = () => {
    setIsEditing((current) => !current);
  };

  // useForm hook
  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema), // use zod to validate the form
    defaultValues: initialData, // set the default values of the form to the initialData
  });

  // extract the isSumitting and isValid properties from the form
  const { isSubmitting, isValid } = form.formState;

  // create an onSubmit handler function
  const onSubmit = async (values: z.infer<typeof formSchema>) => {
    try {
      await axios.patch(`/api/courses/${courseId}`, values); // send a PATCH request to the /api/courses/:courseId endpoint with the form values
      toast.success("Course title updated!");
      toggleEditing(); // toggle the editing state
      router.refresh();
    } catch (error) {
      toast.error("Something went wrong");
    }
  };

  return (
    <div className="mt-6 border bg-slate-100 rounded-md p-4">
      <div className="font-medium flex items-center justify-between">
        Title
        <Button variant="ghost" onClick={toggleEditing}>
        {isEditing ? (
            <>Cancel</>  // if editing, show the cancel button
          ) : (
            <>
                <button
                data-tooltip-id="my-tooltip"
                data-tooltip-content="Edit title"
                data-tooltip-place="top"
              >
                <Pencil className="h-4 w-4 mr-2" />
              </button><Tooltip id="my-tooltip" />
            </>
          )}
        </Button>
      </div>
      {/* if not editing, show the title */}
      {!isEditing && <p className="text-sm mt-2">{initialData.title}</p>}

      {isEditing && (
        <Form {...form}>
          <form
            onSubmit={form.handleSubmit(onSubmit)}
            className="space-y-4 mt-4"
          >
            <FormField
              control={form.control}
              name="title"
              render={({ field }) => (
                <FormItem>
                  <FormControl>
                    <Input
                      disabled={isSubmitting}
                      placeholder="e.g. Intro to Computer Science"
                      {...field}
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
            <div className="flex items-center gap-x-2">
              <Button disabled={!isValid || isSubmitting} type="submit">
                Save
              </Button>
            </div>
          </form>
        </Form>
      )}
    </div>
  );
};

export default TitleForm;

// onSubmit handler function:
// The onSubmit function is called when the form is submitted. It sends a PATCH request to the server with the form data using the axios library. The PATCH request is sent to the /api/courses/:courseId endpoint with the courseId parameter in the URL. The values argument contains the updated course title.

// useForm() hook ******
// The useForm hook returns an object with several properties and methods that are used to interact with the form. These include formState, which contains the state of the form, register, which is used to register form inputs with the form, handleSubmit, which is used to handle form submissions, and reset, which is used to reset the form to its initial state.
